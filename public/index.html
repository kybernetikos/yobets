<html>
<head>
</head>
<body>

Click to establish a websocket connection and send some data:

<button onclick='webconnect();'>webcon</button>
<button onclick='disconnect();'>discon</button>
<button onclick='send();'>send</button>

<script>
var ws;

var imgBlob;

function getAsBlob(fileurl, callback) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", fileurl, true);
	xhr.responseType = "blob";
	xhr.onreadystatechange = function() {
		if (xhr.readyState == 4) {
			callback(xhr.response);
		}
	}
	xhr.send();
}

getAsBlob("sunset.jpg", function(b) {
	imgBlob = b;
});


function handler(req, res) {
  console.log("< ", req);
	res.sendBlob(imgBlob);
}

function webconnect() {
	ws = new WebSocket("ws://localhost:7272/websocket");
  ws.onopen = function() {
     console.log("Connected.");
     console.log("> adam");
     ws.send("adam");
  };
  ws.onmessage = function (evt) { 
     var received_msg = evt.data;
     var request = JSON.parse(received_msg);

     var binaryData = null;
     var resultingCalls = [];
     
     function makeMethod(obj, name) {
    	 obj[name] = function() {resultingCalls.push([name, Array.prototype.slice.call(arguments)])};
     }
     var response = {};
     makeMethod(response, "end");
     makeMethod(response, "contentType");
     response.sendBlob = function(blob) {
       if (blob.type) response.contentType(blob.type);
    	 binaryData = blob;
     }
     
     handler(request, response);
     ws.send(JSON.stringify(resultingCalls));
     if (binaryData != null) {
				ws.send(binaryData);
     }
  };
  ws.onclose = function() { 
     console.log("Disconnected."); 
  };
}

function disconnect() {
	ws.close(1000);
}

function send() {
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "/host/adam/fred?somequery=thistext");
	xhr.setRequestHeader("X-arbheader", "I'm awesome");
	xhr.onreadystatechange = function() {
		if (xhr.readyState == 4) {
			console.log(xhr.responseText);
		}
	}
	xhr.send("BOOOM!");
}

</script>

</body>
</html>